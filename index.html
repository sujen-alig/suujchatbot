<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced AI Chatbot</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/10.6.4/math.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Arial', sans-serif; background: linear-gradient(135deg, #1e3a8a, #3b82f6); }
        .chat-container { max-width: 900px; margin: auto; padding: 20px; background: rgba(255, 255, 255, 0.9); border-radius: 15px; box-shadow: 0 0 20px rgba(0,0,0,0.2); }
        .chat-bubble { padding: 15px; margin: 10px; border-radius: 10px; position: relative; }
        .user-bubble { background: #e0f7fa; }
        .bot-bubble { background: #f0f0f0; }
        .cartoon-icon { width: 100px; height: 100px; background: url('https://via.placeholder.com/100?text=ü§ñ'); background-size: cover; transition: transform 0.3s; }
        .speaking { transform: scale(1.2) rotate(5deg); }
        .hidden { display: none; }
        .login-card { perspective: 1000px; }
        .login-inner { transition: transform 0.6s; transform-style: preserve-3d; }
        .login-inner.flip { transform: rotateY(180deg); }
        .login-front, .login-back { backface-visibility: hidden; }
        .login-back { transform: rotateY(180deg); }
        .particle { position: absolute; background: rgba(255, 255, 255, 0.7); border-radius: 50%; }
        .read-btn { position: absolute; top: 10px; right: 10px; cursor: pointer; }
    </style>
</head>
<body class="min-h-screen">
    <!-- Particle Background -->
    <canvas id="particle-bg" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;"></canvas>

    <!-- Login Page -->
    <div id="login-page" class="container mx-auto p-4 hidden">
        <div class="login-card max-w-md mx-auto">
            <div class="login-inner relative w-full h-96">
                <div class="login-front absolute w-full h-full bg-white rounded-lg shadow-lg p-6">
                    <h1 class="text-3xl font-bold text-center text-blue-600 mb-4 animate-pulse">Login</h1>
                    <form>
                        <input id="login-username" type="text" placeholder="Username" class="border p-3 mb-3 w-full rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300">
                        <input id="login-password" type="password" placeholder="Password" class="border p-3 mb-3 w-full rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300">
                        <button type="button" onclick="login()" class="bg-blue-500 text-white p-3 rounded-lg w-full hover:bg-blue-600 transition duration-300">Login</button>
                        <p class="mt-3 text-center text-white">No account? <a href="#" onclick="flipCard()" class="text-yellow-300 hover:underline">Register</a></p>
                    </form>
                </div>
                <div class="login-back absolute w-full h-full bg-white rounded-lg shadow-lg p-6">
                    <h1 class="text-3xl font-bold text-center text-blue-600 mb-4 animate-pulse">Register</h1>
                    <form>
                        <input id="reg-username" type="text" placeholder="Username" class="border p-3 mb-3 w-full rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300">
                        <input id="reg-password" type="password" placeholder="Password" class="border p-3 mb-3 w-full rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300">
                        <button type="button" onclick="register()" class="bg-blue-500 text-white p-3 rounded-lg w-full hover:bg-blue-600 transition duration-300">Register</button>
                        <p class="mt-3 text-center text-white">Have an account? <a href="#" onclick="flipCard()" class="text-yellow-300 hover:underline">Login</a></p>
                    </form>
                </div>
            </div>
        </div>
        <div class="mt-4 text-center">
            <button onclick="syncData('pull')" class="bg-green-500 text-white p-2 rounded-lg hover:bg-green-600">Sync Data</button>
        </div>
    </div>

    <!-- Chatbot Page -->
    <div id="chatbot-page" class="container mx-auto p-4 hidden">
        <div class="flex justify-between items-center">
            <h1 class="text-4xl font-bold text-white mb-4">AI Chatbot</h1>
            <button onclick="logout()" class="bg-red-500 text-white p-3 rounded-lg hover:bg-red-600">Logout</button>
        </div>
        <div class="chat-container">
            <div class="flex items-center mb-4">
                <div id="cartoon-icon" class="cartoon-icon"></div>
                <span class="ml-3 text-xl font-semibold text-gray-800">AI Assistant</span>
            </div>
            <div id="chat-output" class="h-96 overflow-y-auto mb-4 p-4 bg-gray-100 rounded-lg"></div>
            <div class="flex">
                <input id="chat-input" type="text" placeholder="Ask me anything..." class="border p-3 flex-grow rounded-l-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button onclick="processInput()" class="bg-blue-500 text-white p-3 rounded-r-lg hover:bg-blue-600">Send</button>
                <button onclick="toggleMic()" class="bg-green-500 text-white p-3 rounded-lg ml-2 hover:bg-green-600">üé§ Mic</button>
                <button onclick="voiceOnlyResponse()" class="bg-purple-500 text-white p-3 rounded-lg ml-2 hover:bg-purple-600">üó£Ô∏è Talk</button>
            </div>
            <select id="language-select" onchange="setLanguage(this.value)" class="mt-2 p-2 rounded-lg w-full">
                <option value="en-US">English</option>
                <option value="hi-IN">Hindi</option>
            </select>
            <div class="mt-2 flex gap-2">
                <button onclick="showPage('train-page')" class="bg-blue-500 text-white p-2 rounded-lg flex-1 hover:bg-blue-600">Train Chatbot</button>
                <button onclick="showPage('data-page')" class="bg-yellow-500 text-white p-2 rounded-lg flex-1 hover:bg-yellow-600">View Data</button>
                <button onclick="syncData('push')" class="bg-green-500 text-white p-2 rounded-lg flex-1 hover:bg-green-600">Push Data</button>
                <button onclick="syncData('pull')" class="bg-purple-500 text-white p-2 rounded-lg flex-1 hover:bg-purple-600">Pull Data</button>
            </div>
        </div>
    </div>

    <!-- Train Page -->
    <div id="train-page" class="container mx-auto p-4 hidden">
        <h1 class="text-4xl font-bold text-white mb-4">Train Chatbot</h1>
        <div class="chat-container">
            <input id="train-question" type="text" placeholder="Question" class="border p-3 mb-3 w-full rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            <button onclick="startVoiceTraining('question')" class="bg-green-500 text-white p-3 rounded-lg mb-3 hover:bg-green-600">üé§ Question</button>
            <input id="train-answer" type="text" placeholder="Answer" class="border p-3 mb-3 w-full rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            <button onclick="startVoiceTraining('answer')" class="bg-green-500 text-white p-3 rounded-lg mb-3 hover:bg-green-600">üé§ Answer</button>
            <input id="train-image" type="text" placeholder="Image URL (optional)" class="border p-3 mb-3 w-full rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            <input id="train-link" type="text" placeholder="Web Link (optional)" class="border p-3 mb-3 w-full rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            <button onclick="trainBot()" class="bg-blue-500 text-white p-3 rounded-lg w-full hover:bg-blue-600">Add Training Data</button>
            <button onclick="showPage('chatbot-page')" class="bg-gray-500 text-white p-3 rounded-lg mt-3 w-full hover:bg-gray-600">Back to Chatbot</button>
        </div>
    </div>

    <!-- Data Page -->
    <div id="data-page" class="container mx-auto p-4 hidden">
        <h1 class="text-4xl font-bold text-white mb-4">Data Management</h1>
        <div class="chat-container">
            <h2 class="text-2xl font-semibold mb-2">Chat History</h2>
            <div id="chat-history" class="h-48 overflow-y-auto mb-4 p-4 bg-gray-100 rounded-lg"></div>
            <h2 class="text-2xl font-semibold mb-2">Training Data</h2>
            <div id="training-data" class="h-48 overflow-y-auto mb-4 p-4 bg-gray-100 rounded-lg"></div>
            <button onclick="exportData()" class="bg-green-500 text-white p-3 rounded-lg w-full hover:bg-green-600">Export Data</button>
            <input type="file" id="import-file" accept=".json" class="hidden" onchange="importData()">
            <button onclick="document.getElementById('import-file').click()" class="bg-purple-500 text-white p-3 rounded-lg w-full mt-2 hover:bg-purple-600">Import Data</button>
            <button onclick="clearData()" class="bg-red-500 text-white p-3 rounded-lg w-full mt-2 hover:bg-red-600">Clear Data</button>
            <button onclick="showPage('chatbot-page')" class="bg-gray-500 text-white p-3 rounded-lg w-full mt-2 hover:bg-gray-600">Back to Chatbot</button>
        </div>
    </div>

    <script>
        // Particle Background
        const canvas = document.getElementById('particle-bg');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        const particles = [];
        class Particle {
            constructor() {
                this.x = Math.random() * canvas.width;
                this.y = Math.random() * canvas.height;
                this.size = Math.random() * 5 + 1;
                this.speedX = Math.random() * 2 - 1;
                this.speedY = Math.random() * 2 - 1;
            }
            update() {
                this.x += this.speedX;
                this.y += this.speedY;
                if (this.size > 0.2) this.size -= 0.1;
                if (this.x < 0 || this.x > canvas.width) this.speedX *= -1;
                if (this.y < 0 || this.y > canvas.height) this.speedY *= -1;
            }
            draw() {
                ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
            }
        }
        function initParticles() {
            for (let i = 0; i < 100; i++) particles.push(new Particle());
        }
        function animateParticles() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            particles.forEach(p => { p.update(); p.draw(); });
            particles.filter(p => p.size > 0.2);
            requestAnimationFrame(animateParticles);
        }
        initParticles();
        animateParticles();

        // IndexedDB Setup
        let db;
        const request = indexedDB.open('ChatbotDB', 2);
        request.onupgradeneeded = event => {
            db = event.target.result;
            db.createObjectStore('users', { keyPath: 'username' });
            db.createObjectStore('trainingData', { autoIncrement: true });
            db.createObjectStore('chatHistory', { autoIncrement: true });
        };
        request.onsuccess = event => {
            db = event.target.result;
            loadDataPage();
        };

        // Authentication
        async function login() {
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            const tx = db.transaction('users', 'readonly');
            const store = tx.objectStore('users');
            const request = store.get(username);
            request.onsuccess = () => {
                if (request.result && request.result.password === password) {
                    localStorage.setItem('currentUser', username);
                    showPage('chatbot-page');
                } else {
                    alert('Invalid credentials');
                }
            };
        }

        async function register() {
            const username = document.getElementById('reg-username').value;
            const password = document.getElementById('reg-password').value;
            const tx = db.transaction('users', 'readwrite');
            const store = tx.objectStore('users');
            const request = store.get(username);
            request.onsuccess = () => {
                if (request.result) {
                    alert('Username already exists');
                } else {
                    store.add({ username, password });
                    localStorage.setItem('currentUser', username);
                    showPage('chatbot-page');
                    syncData('push');
                }
            };
        }

        function logout() {
            localStorage.setItem('currentUser', '');
            showPage('login-page');
        }

        // Data Management
        async function loadDataPage() {
            if (document.getElementById('data-page').classList.contains('hidden')) return;
            const tx = db.transaction(['chatHistory', 'trainingData'], 'readonly');
            const chatStore = tx.objectStore('chatHistory');
            const trainingStore = tx.objectStore('trainingData');
            const chats = await new Promise(resolve => {
                chatStore.getAll().onsuccess = e => resolve(e.target.result);
            });
            const trainingData = await new Promise(resolve => {
                trainingStore.getAll().onsuccess = e => resolve(e.target.result);
            });
            const chatHistoryDiv = document.getElementById('chat-history');
            chatHistoryDiv.innerHTML = chats.map(chat => `<p><b>${chat.user}:</b> ${chat.input}<br><b>Bot:</b> ${chat.response}</p>`).join('');
            const trainingDataDiv = document.getElementById('training-data');
            trainingDataDiv.innerHTML = trainingData.map(data => `<p><b>Q:</b> ${data.question}<br><b>A:</b> ${data.answer}${data.image ? `<br><img src="${data.image}" alt="Image" class="w-32 rounded">` : ''}${data.link ? `<br><a href="${data.link}" target="_blank" class="text-blue-500">Link</a>` : ''}</p>`).join('');
        }

        async function exportData() {
            const tx = db.transaction(['users', 'trainingData', 'chatHistory'], 'readonly');
            const userStore = tx.objectStore('users');
            const trainingStore = tx.objectStore('trainingData');
            const chatStore = tx.objectStore('chatHistory');
            const users = await new Promise(resolve => {
                userStore.getAll().onsuccess = e => resolve(e.target.result);
            });
            const trainingData = await new Promise(resolve => {
                trainingStore.getAll().onsuccess = e => resolve(e.target.result);
            });
            const chatHistory = await new Promise(resolve => {
                chatStore.getAll().onsuccess = e => resolve(e.target.result);
            });
            const data = {
                users: Object.fromEntries(users.map(u => [u.username, u])),
                trainingData,
                chatHistory
            };
            const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'chatbot-data.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        async function importData() {
            const file = document.getElementById('import-file').files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async e => {
                const data = JSON.parse(e.target.result);
                const tx = db.transaction(['users', 'trainingData', 'chatHistory'], 'readwrite');
                const userStore = tx.objectStore('users');
                const trainingStore = tx.objectStore('trainingData');
                const chatStore = tx.objectStore('chatHistory');
                userStore.clear();
                trainingStore.clear();
                chatStore.clear();
                Object.values(data.users).forEach(user => userStore.add(user));
                data.trainingData.forEach(item => trainingStore.add(item));
                data.chatHistory.forEach(item => chatStore.add(item));
                await tx.complete;
                alert('Data imported successfully!');
                loadDataPage();
            };
            reader.readAsText(file);
        }

        async function clearData() {
            if (!confirm('Are you sure you want to clear all data?')) return;
            const tx = db.transaction(['users', 'trainingData', 'chatHistory'], 'readwrite');
            tx.objectStore('users').clear();
            tx.objectStore('trainingData').clear();
            tx.objectStore('chatHistory').clear();
            await tx.complete;
            alert('Data cleared!');
            loadDataPage();
        }

        // Data Sync (GitHub JSON)
        async function syncData(action) {
            const repoUrl = 'https://raw.githubusercontent.com/<YOUR_GITHUB_USERNAME>/<YOUR_REPO_NAME>/main/data.json'; // Replace with your repo
            if (action === 'pull') {
                try {
                    const response = await fetch(repoUrl);
                    const data = await response.json();
                    const tx = db.transaction(['users', 'trainingData', 'chatHistory'], 'readwrite');
                    const userStore = tx.objectStore('users');
                    const trainingStore = tx.objectStore('trainingData');
                    const chatStore = tx.objectStore('chatHistory');
                    userStore.clear();
                    trainingStore.clear();
                    chatStore.clear();
                    Object.values(data.users).forEach(user => userStore.add(user));
                    data.trainingData.forEach(item => trainingStore.add(item));
                    data.chatHistory.forEach(item => chatStore.add(item));
                    await tx.complete;
                    alert('Data synced from GitHub!');
                    loadDataPage();
                } catch {
                    alert('Sync failed. Check repo URL or network.');
                }
            } else if (action === 'push') {
                const tx = db.transaction(['users', 'trainingData', 'chatHistory'], 'readonly');
                const userStore = tx.objectStore('users');
                const trainingStore = tx.objectStore('trainingData');
                const chatStore = tx.objectStore('chatHistory');
                const users = await new Promise(resolve => {
                    userStore.getAll().onsuccess = e => resolve(e.target.result);
                });
                const trainingData = await new Promise(resolve => {
                    trainingStore.getAll().onsuccess = e => resolve(e.target.result);
                });
                const chatHistory = await new Promise(resolve => {
                    chatStore.getAll().onsuccess = e => resolve(e.target.result);
                });
                const data = {
                    users: Object.fromEntries(users.map(u => [u.username, u])),
                    trainingData,
                    chatHistory
                };
                console.log('Push to GitHub: Update data.json manually or use GitHub API', data);
                alert('Data ready to push. Update data.json in GitHub repo manually.');
            }
        }

        function showPage(pageId) {
            document.querySelectorAll('.container').forEach(page => page.classList.add('hidden'));
            document.getElementById(pageId).classList.remove('hidden');
            if (pageId === 'data-page') loadDataPage();
        }

        // Check login status
        if (localStorage.getItem('currentUser')) {
            showPage('chatbot-page');
        } else {
            showPage('login-page');
        }

        // Flip card for login/register
        function flipCard() {
            document.querySelector('.login-inner').classList.toggle('flip');
        }

        // Chatbot Logic
        let recognition;
        let isListening = false;
        const chatOutput = document.getElementById('chat-output');
        const chatInput = document.getElementById('chat-input');
        const cartoonIcon = document.getElementById('cartoon-icon');

        async function addMessage(message, isUser = false, speakable = true, input = '') {
            const div = document.createElement('div');
            div.className = `chat-bubble ${isUser ? 'user-bubble' : 'bot-bubble'}`;
            div.innerHTML = message;
            if (!isUser && speakable) {
                const readBtn = document.createElement('span');
                readBtn.className = 'read-btn';
                readBtn.innerHTML = 'üì¢';
                readBtn.onclick = () => speak(message.replace(/<[^>]+>/g, ''));
                div.appendChild(readBtn);
            }
            chatOutput.appendChild(div);
            chatOutput.scrollTop = chatOutput.scrollHeight;
            if (!isUser) {
                cartoonIcon.classList.add('speaking');
                setTimeout(() => cartoonIcon.classList.remove('speaking'), 2000);
            }
            if (input) {
                const tx = db.transaction('chatHistory', 'readwrite');
                const store = tx.objectStore('chatHistory');
                store.add({ user: localStorage.getItem('currentUser'), input, response: message });
                await tx.complete;
            }
        }

        function correctInput(input) {
            const corrections = {
                'tel': 'tell', 'abot': 'about', 'javascritp': 'javascript', 'youtub': 'youtube',
                'primeminister': 'prime minister', 'calulate': 'calculate', 'wether': 'weather',
                'translat': 'translate', 'pythn': 'python', 'htmls': 'html', 'javas': 'javascript',
                'logn': 'login', 'cod': 'code', 'wikipdia': 'wikipedia', 'cretae': 'create',
                'adavnced': 'advanced', 'lgin': 'login', 'pge': 'page', 'deeted': 'deleted'
            };
            let corrected = input.toLowerCase();
            for (const [wrong, right] of Object.entries(corrections)) {
                corrected = corrected.replace(new RegExp(wrong, 'gi'), right);
            }
            if (corrected.includes('prime') && corrected.includes('india')) corrected = 'prime minister of india';
            if (corrected.includes('java') && !corrected.includes('javascript')) corrected = 'about javascript';
            if (corrected.includes('code') && corrected.includes('log')) corrected = 'create a login page';
            if (corrected.includes('create') && corrected.includes('login')) corrected = 'create a login page';
            if (corrected.includes('advanced') && corrected.includes('login')) corrected = 'create a login page';
            return corrected;
        }

        async function processInput(voiceOnly = false) {
            let input = chatInput.value.trim();
            if (!input) return;
            input = correctInput(input);
            if (!voiceOnly) addMessage(input, true, false, input);
            chatInput.value = '';

            let response = '';
            const tx = db.transaction('trainingData', 'readonly');
            const store = tx.objectStore('trainingData');
            const trainingData = await new Promise(resolve => {
                store.getAll().onsuccess = e => resolve(e.target.result);
            });
            const matchedData = trainingData.find(data => data.question.toLowerCase() === input) ||
                               trainingData.find(data => input.includes(data.question.toLowerCase()));

            if (matchedData) {
                response = matchedData.answer;
                if (matchedData.image) response += `<br><img src="${matchedData.image}" alt="Image" class="w-32 rounded">`;
                if (matchedData.link) response += `<br><a href="${matchedData.link}" target="_blank" class="text-blue-500 hover:underline">Learn More</a>`;
            } else if (input.includes('how are you')) {
                response = "I'm doing fantastic, thanks for asking! What's on your mind? üòÑ";
            } else if (input.includes('prime minister of india')) {
                response = await fetchWikipedia('Narendra Modi') || 'The Prime Minister of India is Narendra Modi. <br><img src="https://via.placeholder.com/150?text=PM" alt="PM Image" class="w-32 rounded">';
            } else if (input.includes('about javascript')) {
                response = 'JavaScript is a powerful programming language used for web development, enabling dynamic content and interactivity. <br><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript" target="_blank" class="text-blue-500 hover:underline">Learn More</a>';
            } else if (input.includes('create a login page')) {
                response = `
                    <h3>Advanced HTML Login Page</h3>
                    <pre>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Login</title>
    <style>
        body { background: linear-gradient(135deg, #1e3a8a, #3b82f6); display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .card { max-width: 400px; padding: 20px; background: rgba(255,255,255,0.9); border-radius: 10px; box-shadow: 0 0 20px rgba(0,0,0,0.2); }
        input { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 5px; }
        button { width: 100%; padding: 10px; background: #3b82f6; color: white; border: none; border-radius: 5px; cursor: pointer; transition: background 0.3s; }
        button:hover { background: #1e3a8a; }
    </style>
</head>
<body>
    <div class="card">
        <h2>Login</h2>
        <input type="text" placeholder="Username">
        <input type="password" placeholder="Password">
        <button>Login</button>
    </div>
</body>
</html>
                    </pre>`;
            } else if (input.includes('python code')) {
                response = `
                    <h3>Python Example: Fibonacci Sequence</h3>
                    <pre>
def fibonacci(n):
    fib = [0, 1]
    for i in range(2, n):
        fib.append(fib[i-1] + fib[i-2])
    return fib

print(fibonacci(10))  # Output: [0, 1, 1, 2, 3, 5, 8, 13, 21, 34]
                    </pre>`;
            } else if (input.includes('javascript code')) {
                response = `
                    <h3>JavaScript Example: Todo List</h3>
                    <pre>
const todos = [];
function addTodo(task) {
    todos.push(task);
    console.log('Added:', task);
}
addTodo('Learn JavaScript');
console.log(todos); // Output: ['Learn JavaScript']
                    </pre>`;
            } else if (input.includes('open youtube') || input.includes('open yt')) {
                window.open('https://www.youtube.com', '_blank');
                response = "Opening YouTube for you! Enjoy! üòÑ";
            } else if (input.includes('translate')) {
                response = await translateText(input);
            } else if (input.includes('weather')) {
                response = await fetchWeather(input);
            } else {
                try {
                    const result = math.evaluate(input);
                    response = `Result: ${result}`;
                } catch {
                    response = await fetchWikipedia(input) || await fetchGeneralKnowledge(input) || "Here's what I know: Try asking in a different way or check out my training page to teach me more! üòä";
                }
            }

            if (voiceOnly) {
                speak(response.replace(/<[^>]+>/g, ''));
            } else {
                addMessage(response, false, true, input);
            }
        }

        async function voiceOnlyResponse() {
            if (!chatInput.value.trim()) {
                speak("Please say or type something for me to respond to!");
                return;
            }
            await processInput(true);
        }

        // Wikipedia API (with image support)
        async function fetchWikipedia(query) {
            try {
                const response = await fetch(`https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(query)}`);
                const data = await response.json();
                if (data.extract) {
                    let result = data.extract;
                    if (data.thumbnail) {
                        result += `<br><img src="${data.thumbnail.source}" alt="${query}" class="w-32 rounded">`;
                    } else if (query.match(/^[A-Z][a-z]+ [A-Z][a-z]+$/)) { // Likely a person's name
                        result += `<br><img src="https://via.placeholder.com/150?text=${query}" alt="${query}" class="w-32 rounded">`;
                    }
                    return result;
                }
                return null;
            } catch {
                return null;
            }
        }

        // General Knowledge Fallback (DuckDuckGo API)
        async function fetchGeneralKnowledge(query) {
            try {
                const response = await fetch(`https://api.duckduckgo.com/?q=${encodeURIComponent(query)}&format=json`);
                const data = await response.json();
                if (data.Abstract) {
                    return `${data.Abstract} <br><a href="${data.AbstractURL}" target="_blank" class="text-blue-500 hover:underline">Read More</a>`;
                }
                return null;
            } catch {
                return null;
            }
        }

        // Translation API
        async function translateText(input) {
            const match = input.match(/translate (.+) to (.+)/i);
            if (!match) return "Please specify text and target language (e.g., 'translate hello to Spanish').";
            const text = match[1];
            const targetLang = match[2].toLowerCase();
            const langMap = { spanish: 'es', hindi: 'hi', french: 'fr', urdu: 'ur' };
            const langCode = langMap[targetLang] || 'en';
            try {
                const response = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=en|${langCode}`);
                const data = await response.json();
                return data.responseData.translatedText;
            } catch {
                return "Translation failed. Try again later.";
            }
        }

        // Weather API
        async function fetchWeather(input) {
            const match = input.match(/weather in (.+)/i);
            if (!match) return "Please specify a location (e.g., 'weather in Delhi').";
            const location = match[1];
            try {
                const response = await fetch(`https://wttr.in/${encodeURIComponent(location)}?format=%C+%t`);
                const data = await response.text();
                return `Weather in ${location}: ${data}`;
            } catch {
                return "Weather data unavailable. Try again later.";
            }
        }

        // Voice Input
        if ('webkitSpeechRecognition' in window) {
            recognition = new webkitSpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US';

            recognition.onresult = event => {
                let interimTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        chatInput.value = transcript;
                        processInput();
                    } else {
                        interimTranscript += transcript;
                    }
                }
                chatInput.value = interimTranscript;
            };

            recognition.onend = () => {
                if (isListening) recognition.start();
            };
        }

        function toggleMic() {
            if (!recognition) {
                alert('Speech recognition not supported in this browser.');
                return;
            }
            if (isListening) {
                recognition.stop();
                document.querySelector('button[onclick="toggleMic()"]').textContent = 'üé§ Mic';
                isListening = false;
            } else {
                recognition.start();
                document.querySelector('button[onclick="toggleMic()"]').textContent = 'üé§ Stop';
                isListening = true;
            }
        }

        // Voice Training
        let trainingField = null;
        function startVoiceTraining(field) {
            if (!recognition) {
                alert('Speech recognition not supported in this browser.');
                return;
            }
            trainingField = field;
            recognition.onresult = event => {
                const transcript = event.results[event.results.length - 1][0].transcript;
                if (event.results[event.results.length - 1].isFinal) {
                    document.getElementById(`train-${trainingField}`).value = transcript;
                    recognition.stop();
                    trainingField = null;
                    recognition.onresult = event => {
                        let interimTranscript = '';
                        for (let i = event.resultIndex; i < event.results.length; i++) {
                            const transcript = event.results[i][0].transcript;
                            if (event.results[i].isFinal) {
                                chatInput.value = transcript;
                                processInput();
                            } else {
                                interimTranscript += transcript;
                            }
                        }
                        chatInput.value = interimTranscript;
                    };
                }
            };
            recognition.start();
        }

        // Voice Output
        function speak(text) {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = document.getElementById('language-select').value;
            utterance.rate = 1;
            utterance.pitch = 1;
            utterance.onstart = () => cartoonIcon.classList.add('speaking');
            utterance.onend = () => cartoonIcon.classList.remove('speaking');
            speechSynthesis.speak(utterance);
        }

        // Training System
        async function trainBot() {
            const question = document.getElementById('train-question').value;
            const answer = document.getElementById('train-answer').value;
            const image = document.getElementById('train-image').value;
            const link = document.getElementById('train-link').value;
            if (!question || !answer) {
                alert('Please provide both question and answer');
                return;
            }
            const tx = db.transaction('trainingData', 'readwrite');
            const store = tx.objectStore('trainingData');
            store.add({ question, answer, image, link });
            await tx.complete;
            alert('Training data added!');
            document.getElementById('train-question').value = '';
            document.getElementById('train-answer').value = '';
            document.getElementById('train-image').value = '';
            document.getElementById('train-link').value = '';
            syncData('push');
        }

        // Handle text input
        chatInput.addEventListener('keypress', e => {
            if (e.key === 'Enter') processInput();
        });

        // Multi-language support
        function setLanguage(lang) {
            if (recognition) recognition.lang = lang;
        }

        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js').then(reg => {
                console.log('Service Worker registered', reg);
            }).catch(err => {
                console.error('Service Worker registration failed', err);
            });
        }
    </script>
</body>
</html>
