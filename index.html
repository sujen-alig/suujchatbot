<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced AI Chatbot</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/10.6.4/math.min.js"></script>
    <link href="/styles.css" rel="stylesheet">
    <style>
        body { font-family: 'Arial', sans-serif; background: linear-gradient(135deg, #1e3a8a, #3b82f6); }
        .chat-container { max-width: 900px; margin: auto; padding: 20px; background: rgba(255, 255, 255, 0.9); border-radius: 15px; box-shadow: 0 0 20px rgba(0,0,0,0.2); }
        .chat-bubble { padding: 15px; margin: 10px; border-radius: 10px; position: relative; }
        .user-bubble { background: #e0f7fa; }
        .bot-bubble { background: #f0f0f0; }
        .cartoon-icon { width: 100px; height: 100px; background: url('https://via.placeholder.com/100?text=ü§ñ'); background-size: cover; transition: transform 0.3s; }
        .speaking { transform: scale(1.2) rotate(5deg); }
        .hidden { display: none; }
        .login-card { perspective: 1000px; }
        .login-inner { transition: transform 0.6s; transform-style: preserve-3d; }
        .login-inner.flip { transform: rotateY(180deg); }
        .login-front, .login-back { backface-visibility: hidden; }
        .login-back { transform: rotateY(180deg); }
        .particle { position: absolute; background: rgba(255, 255, 255, 0.7); border-radius: 50%; }
        .read-btn { position: absolute; top: 10px; right: 10px; cursor: pointer; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
    </style>
</head>
<body class="min-h-screen">
    <!-- Particle Background -->
    <canvas id="particle-bg" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;"></canvas>

    <!-- Login Page -->
    <div id="login-page" class="container mx-auto p-4 hidden">
        <div class="login-card max-w-md mx-auto">
            <div class="login-inner relative w-full h-96">
                <div class="login-front absolute w-full h-full bg-white rounded-lg shadow-lg p-6">
                    <h1 class="text-3xl font-bold text-center text-blue-600 mb-4 animate-pulse">Login</h1>
                    <form>
                        <input id="login-username" type="text" placeholder="Username" class="border p-3 mb-3 w-full rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300">
                        <input id="login-password" type="password" placeholder="Password" class="border p-3 mb-3 w-full rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300">
                        <button type="button" onclick="login()" class="bg-blue-500 text-white p-3 rounded-lg w-full hover:bg-blue-600 transition duration-300">Login</button>
                        <p class="mt-3 text-center text-white">No account? <a href="#" onclick="flipCard()" class="text-yellow-300 hover:underline">Register</a></p>
                    </form>
                </div>
                <div class="login-back absolute w-full h-full bg-white rounded-lg shadow-lg p-6">
                    <h1 class="text-3xl font-bold text-center text-blue-600 mb-4 animate-pulse">Register</h1>
                    <form>
                        <input id="reg-username" type="text" placeholder="Username" class="border p-3 mb-3 w-full rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300">
                        <input id="reg-password" type="password" placeholder="Password" class="border p-3 mb-3 w-full rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300">
                        <button type="button" onclick="register()" class="bg-blue-500 text-white p-3 rounded-lg w-full hover:bg-blue-600 transition duration-300">Register</button>
                        <p class="mt-3 text-center text-white">Have an account? <a href="#" onclick="flipCard()" class="text-yellow-300 hover:underline">Login</a></p>
                    </form>
                </div>
            </div>
        </div>
        <div class="mt-4 text-center">
            <button onclick="syncData('pull')" class="bg-green-500 text-white p-2 rounded-lg hover:bg-green-600">Sync Data</button>
        </div>
    </div>

    <!-- Chatbot Page -->
    <div id="chatbot-page" class="container mx-auto p-4 hidden">
        <div class="flex justify-between items-center">
            <h1 class="text-4xl font-bold text-white mb-4">AI Chatbot</h1>
            <button onclick="logout()" class="bg-red-500 text-white p-3 rounded-lg hover:bg-red-600">Logout</button>
        </div>
        <div class="chat-container">
            <div class="flex items-center mb-4">
                <div id="cartoon-icon" class="cartoon-icon"></div>
                <span class="ml-3 text-xl font-semibold text-gray-800">AI Assistant</span>
            </div>
            <div id="chat-output" class="h-96 overflow-y-auto mb-4 p-4 bg-gray-100 rounded-lg"></div>
            <div class="flex">
                <input id="chat-input" type="text" placeholder="Ask me anything..." class="border p-3 flex-grow rounded-l-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button onclick="processInput()" class="bg-blue-500 text-white p-3 rounded-r-lg hover:bg-blue-600">Send</button>
                <button onclick="toggleMic()" class="bg-green-500 text-white p-3 rounded-lg ml-2 hover:bg-green-600">üé§ Mic</button>
                <button onclick="voiceOnlyResponse()" class="bg-purple-500 text-white p-3 rounded-lg ml-2 hover:bg-purple-600">üó£Ô∏è Talk</button>
            </div>
            <select id="language-select" onchange="setLanguage(this.value)" class="mt-2 p-2 rounded-lg w-full">
                <option value="en-US">English</option>
                <option value="hi-IN">Hindi</option>
            </select>
            <div class="mt-2 flex gap-2">
                <button onclick="showPage('train-page')" class="bg-blue-500 text-white p-2 rounded-lg flex-1 hover:bg-blue-600">Train Chatbot</button>
                <button onclick="showPage('data-page')" class="bg-yellow-500 text-white p-2 rounded-lg flex-1 hover:bg-yellow-600">View Data</button>
                <button onclick="syncData('push')" class="bg-green-500 text-white p-2 rounded-lg flex-1 hover:bg-green-600">Push Data</button>
                <button onclick="syncData('pull')" class="bg-purple-500 text-white p-2 rounded-lg flex-1 hover:bg-purple-600">Pull Data</button>
            </div>
        </div>
    </div>

    <!-- Train Page -->
    <div id="train-page" class="container mx-auto p-4 hidden">
        <h1 class="text-4xl font-bold text-white mb-4">Train Chatbot</h1>
        <div class="chat-container">
            <input id="train-question" type="text" placeholder="Question" class="border p-3 mb-3 w-full rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            <button onclick="startVoiceTraining('question')" class="bg-green-500 text-white p-3 rounded-lg mb-3 hover:bg-green-600">üé§ Question</button>
            <input id="train-answer" type="text" placeholder="Answer" class="border p-3 mb-3 w-full rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            <button onclick="startVoiceTraining('answer')" class="bg-green-500 text-white p-3 rounded-lg mb-3 hover:bg-green-600">üé§ Answer</button>
            <input id="train-image" type="text" placeholder="Image URL (optional)" class="border p-3 mb-3 w-full rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            <input id="train-link" type="text" placeholder="Web Link (optional)" class="border p-3 mb-3 w-full rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            <input id="train-file" type="file" accept="text/plain,image/*" class="border p-3 mb-3 w-full rounded-lg">
            <button onclick="trainBot()" class="bg-blue-500 text-white p-3 rounded-lg w-full hover:bg-blue-600">Add Training Data</button>
            <button onclick="showPage('chatbot-page')" class="bg-gray-500 text-white p-3 rounded-lg mt-3 w-full hover:bg-gray-600">Back to Chatbot</button>
        </div>
    </div>

    <!-- Data View Page -->
    <div id="data-page" class="container mx-auto p-4 hidden">
        <h1 class="text-4xl font-bold text-white mb-4">Training Data</h1>
        <div class="chat-container">
            <table id="data-table">
                <thead>
                    <tr>
                        <th>Question</th>
                        <th>Answer</th>
                        <th>Image</th>
                        <th>Link</th>
                        <th>File</th>
                    </tr>
                </thead>
                <tbody id="data-table-body"></tbody>
            </table>
            <button onclick="showPage('chatbot-page')" class="bg-gray-500 text-white p-3 rounded-lg mt-3 w-full hover:bg-gray-600">Back to Chatbot</button>
        </div>
    </div>

    <script>
        // Particle Background
        const canvas = document.getElementById('particle-bg');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        const particles = [];
        class Particle {
            constructor() {
                this.x = Math.random() * canvas.width;
                this.y = Math.random() * canvas.height;
                this.size = Math.random() * 5 + 1;
                this.speedX = Math.random() * 2 - 1;
                this.speedY = Math.random() * 2 - 1;
            }
            update() {
                this.x += this.speedX;
                this.y += this.speedY;
                if (this.size > 0.2) this.size -= 0.1;
                if (this.x < 0 || this.x > canvas.width) this.speedX *= -1;
                if (this.y < 0 || this.y > canvas.height) this.speedY *= -1;
            }
            draw() {
                ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
            }
        }
        function initParticles() {
            for (let i = 0; i < 100; i++) particles.push(new Particle());
        }
        function animateParticles() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            particles.forEach(p => { p.update(); p.draw(); });
            requestAnimationFrame(animateParticles);
        }
        initParticles();
        animateParticles();

        // Image Error Handler
        function handleImageError(img) {
            try {
                console.log('Image failed to load:', img.src);
                img.src = 'https://via.placeholder.com/150?text=Image+Not+Found';
            } catch (error) {
                console.error('Image error handler:', error);
            }
        }

        // Sanitize URL
        function sanitizeUrl(url) {
            try {
                if (!url || typeof url !== 'string') return '';
                return url.replace(/[<>"'&]/g, '');
            } catch (error) {
                console.error('Sanitize URL error:', error);
                return '';
            }
        }

        // GitHub API Config
        let githubToken = localStorage.getItem('githubToken');
        let repoOwner = '<YOUR_GITHUB_USERNAME>'; // Replace with your GitHub username
        let repoName = '<YOUR_REPO_NAME>'; // Replace with your repo name
        const filePath = 'data.json';
        let apiBaseUrl = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${filePath}`;

        // Prompt for GitHub configuration if not set
        function configureGitHub() {
            if (repoOwner.includes('<YOUR_GITHUB_USERNAME>') || repoName.includes('<YOUR_REPO_NAME>')) {
                repoOwner = prompt('Enter your GitHub username:');
                repoName = prompt('Enter your repository name:');
                if (!repoOwner || !repoName) {
                    alert('GitHub username and repository name are required. Please reload and try again.');
                    throw new Error('Missing GitHub configuration');
                }
                apiBaseUrl = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${filePath}`;
            }
            if (!githubToken) {
                githubToken = prompt('Enter your GitHub Personal Access Token (must have repo scope):');
                if (!githubToken) {
                    alert('GitHub token is required. Please reload and try again.');
                    throw new Error('Missing GitHub token');
                }
                localStorage.setItem('githubToken', githubToken);
            }
        }

        configureGitHub();

        // Validate repository configuration
        async function validateRepo(retry = true) {
            try {
                const response = await fetch(`https://api.github.com/repos/${repoOwner}/${repoName}`, {
                    headers: {
                        'Authorization': `Bearer ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                if (!response.ok) {
                    let errorMessage = 'Repository validation failed';
                    let errorData;
                    try {
                        errorData = await response.json();
                        errorMessage = errorData.message || errorMessage;
                    } catch {
                        errorMessage += `: HTTP ${response.status}`;
                    }
                    if (response.status === 401) {
                        errorMessage = 'Invalid GitHub token. Please provide a token with repo scope.';
                        if (retry) {
                            localStorage.removeItem('githubToken');
                            githubToken = prompt('Enter a valid GitHub Personal Access Token with repo scope:');
                            if (!githubToken) throw new Error('No token provided');
                            localStorage.setItem('githubToken', githubToken);
                            return validateRepo(false);
                        }
                    } else if (response.status === 403) {
                        errorMessage = 'Permission denied. Ensure token has repo scope and you have write access.';
                    } else if (response.status === 404) {
                        errorMessage = `Repository not found: ${repoOwner}/${repoName}. Check username and repository name.`;
                    }
                    throw new Error(errorMessage);
                }
                console.log('Repository validated successfully');
                return true;
            } catch (error) {
                console.error('Repository validation error:', error.message, error.stack);
                alert(`Invalid repository or token: ${error.message}. Please check repoOwner, repoName, and token.`);
                return false;
            }
        }

        // IndexedDB Setup
        let db;
        const request = indexedDB.open('ChatbotDB', 7);
        request.onupgradeneeded = event => {
            db = event.target.result;
            if (!db.objectStoreNames.contains('users')) {
                db.createObjectStore('users', { keyPath: 'username' });
            }
            if (!db.objectStoreNames.contains('trainingData')) {
                const trainingDataStore = db.createObjectStore('trainingData', { autoIncrement: true });
                const preTrainingData = [
                    { question: "What is JavaScript?", answer: "JavaScript is a programming language for dynamic web content.", image: "", link: "https://developer.mozilla.org/en-US/docs/Web/JavaScript", file: null },
                    { question: "Prime Minister of India", answer: "Narendra Modi is the Prime Minister of India.", image: "https://via.placeholder.com/150?text=PM", link: "", file: null },
                    { question: "1+1", answer: "2", image: "", link: "", file: null },
                    { question: "Translate hello to Spanish", answer: "Hola", image: "", link: "", file: null },
                    { question: "Weather in Delhi", answer: "Check current weather in Delhi.", image: "", link: "", file: null }
                ];
                preTrainingData.forEach(data => trainingDataStore.add(data));
            }
            if (!db.objectStoreNames.contains('chats')) {
                db.createObjectStore('chats', { autoIncrement: true });
            }
        };
        request.onsuccess = event => {
            db = event.target.result;
            syncData('pull'); // Auto-pull on load
        };
        request.onerror = event => {
            console.error('IndexedDB error:', event.target.error);
            alert('Failed to initialize local storage');
        };

        // Authentication
        async function login() {
            try {
                const username = document.getElementById('login-username').value;
                const password = document.getElementById('login-password').value;
                const tx = db.transaction('users', 'readonly');
                const store = tx.objectStore('users');
                const request = store.get(username);
                request.onsuccess = () => {
                    if (request.result && request.result.password === password) {
                        localStorage.setItem('currentUser', username);
                        loadChats();
                        showPage('chatbot-page');
                    } else {
                        alert('Invalid credentials');
                    }
                };
                request.onerror = () => {
                    alert('Error checking credentials');
                };
            } catch (error) {
                console.error('Login error:', error);
                alert('Login failed');
            }
        }

        async function register() {
            try {
                const username = document.getElementById('reg-username').value;
                const password = document.getElementById('reg-password').value;
                const tx = db.transaction('users', 'readwrite');
                const store = tx.objectStore('users');
                const request = store.get(username);
                request.onsuccess = async () => {
                    if (request.result) {
                        alert('Username already exists');
                    } else {
                        await store.add({ username, password });
                        localStorage.setItem('currentUser', username);
                        showPage('chatbot-page');
                        await syncData('push');
                    }
                };
                request.onerror = () => {
                    alert('Error registering user');
                };
            } catch (error) {
                console.error('Register error:', error);
                alert('Registration failed');
            }
        }

        function logout() {
            localStorage.setItem('currentUser', '');
            showPage('login-page');
        }

        // Data Sync (GitHub API)
        async function syncData(action) {
            try {
                if (!(await validateRepo())) return;
                if (action === 'pull') {
                    const response = await fetch(apiBaseUrl, {
                        headers: {
                            'Authorization': `Bearer ${githubToken}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    if (!response.ok) {
                        if (response.status === 404) {
                            await createDataJson();
                            return syncData('pull');
                        }
                        const errorData = await response.json();
                        throw new Error(`Failed to fetch data.json: ${errorData.message || 'Unknown error'}`);
                    }
                    const data = await response.json();
                    const content = JSON.parse(atob(data.content));
                    const tx = db.transaction(['users', 'trainingData', 'chats'], 'readwrite');
                    const userStore = tx.objectStore('users');
                    const trainingStore = tx.objectStore('trainingData');
                    const chatStore = tx.objectStore('chats');
                    await Promise.all([
                        new Promise(resolve => { userStore.clear().onsuccess = resolve; }),
                        new Promise(resolve => { trainingStore.clear().onsuccess = resolve; }),
                        new Promise(resolve => { chatStore.clear().onsuccess = resolve; })
                    ]);
                    Object.values(content.users).forEach(user => userStore.add(user));
                    content.trainingData.forEach(item => trainingStore.add(item));
                    content.chats.forEach(chat => chatStore.add(chat));
                    console.log('Data synced from GitHub');
                    loadChats();
                    loadTrainingData();
                } else if (action === 'push') {
                    const tx = db.transaction(['users', 'trainingData', 'chats'], 'readonly');
                    const userStore = tx.objectStore('users');
                    const trainingStore = tx.objectStore('trainingData');
                    const chatStore = tx.objectStore('chats');
                    const [users, trainingData, chats] = await Promise.all([
                        new Promise(resolve => { userStore.getAll().onsuccess = e => resolve(e.target.result); }),
                        new Promise(resolve => { trainingStore.getAll().onsuccess = e => resolve(e.target.result); }),
                        new Promise(resolve => { chatStore.getAll().onsuccess = e => resolve(e.target.result); })
                    ]);
                    const data = {
                        users: Object.fromEntries(users.map(u => [u.username, u])),
                        trainingData,
                        chats
                    };
                    const base64Content = btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2))));
                    const shaResponse = await fetch(apiBaseUrl, {
                        headers: {
                            'Authorization': `Bearer ${githubToken}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    let sha;
                    if (shaResponse.ok) {
                        sha = (await shaResponse.json()).sha;
                    }
                    const response = await fetch(apiBaseUrl, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${githubToken}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: 'Update data.json',
                            content: base64Content,
                            sha: sha
                        })
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`Failed to update data.json: ${errorData.message || 'Unknown error'}`);
                    }
                    console.log('Data pushed to GitHub');
                }
            } catch (error) {
                console.error('Sync error:', error);
                alert('Sync failed: ' + error.message);
            }
        }

        // Create data.json if it doesn't exist
        async function createDataJson(retry = true) {
            try {
                if (!(await validateRepo(retry))) {
                    throw new Error('Repository validation failed');
                }
                const initialData = {
                    users: {},
                    trainingData: [
                        { question: "What is JavaScript?", answer: "JavaScript is a programming language for dynamic web content.", image: "", link: "https://developer.mozilla.org/en-US/docs/Web/JavaScript", file: null },
                        { question: "Prime Minister of India", answer: "Narendra Modi is the Prime Minister of India.", image: "https://via.placeholder.com/150?text=PM", link: "", file: null },
                        { question: "1+1", answer: "2", image: "", link: "", file: null },
                        { question: "Translate hello to Spanish", answer: "Hola", image: "", link: "", file: null },
                        { question: "Weather in Delhi", answer: "Check current weather in Delhi.", image: "", link: "", file: null }
                    ],
                    chats: []
                };
                const base64Content = btoa(unescape(encodeURIComponent(JSON.stringify(initialData, null, 2))));
                const response = await fetch(apiBaseUrl, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: 'Create data.json',
                        content: base64Content
                    })
                });
                if (!response.ok) {
                    let errorMessage = 'Failed to create data.json';
                    let errorData;
                    try {
                        errorData = await response.json();
                        errorMessage = errorData.message || errorMessage;
                    } catch {
                        errorMessage += `: HTTP ${response.status}`;
                    }
                    if (response.status === 401 && retry) {
                        localStorage.removeItem('githubToken');
                        githubToken = prompt('Enter a valid GitHub Personal Access Token with repo scope:');
                        if (!githubToken) throw new Error('No token provided');
                        localStorage.setItem('githubToken', githubToken);
                        return createDataJson(false);
                    } else if (response.status === 403) {
                        errorMessage = 'Permission denied. Ensure token has repo scope and you have write access.';
                    } else if (response.status === 404) {
                        errorMessage = `Repository not found: ${repoOwner}/${repoName}. Check username and repository name.`;
                    }
                    throw new Error(errorMessage);
                }
                console.log('data.json created successfully');
            } catch (error) {
                console.error('Create data.json error:', error);
                alert('Failed to create data.json: ' + error.message);
                throw error;
            }
        }

        function showPage(pageId) {
            document.querySelectorAll('.container').forEach(page => page.classList.add('hidden'));
            document.getElementById(pageId).classList.remove('hidden');
            if (pageId === 'data-page') loadTrainingData();
        }

        // Check login status
        if (localStorage.getItem('currentUser')) {
            showPage('chatbot-page');
            loadChats();
        } else {
            showPage('login-page');
        }

        // Flip card for login/register
        function flipCard() {
            document.querySelector('.login-inner').classList.toggle('flip');
        }

        // Chatbot Logic
        let recognition;
        let isListening = false;
        const chatOutput = document.getElementById('chat-output');
        const chatInput = document.getElementById('chat-input');
        const cartoonIcon = document.getElementById('cartoon-icon');

        async function loadChats() {
            try {
                chatOutput.innerHTML = '';
                const tx = db.transaction('chats', 'readonly');
                const store = tx.objectStore('chats');
                const chats = await new Promise(resolve => {
                    store.getAll().onsuccess = e => resolve(e.target.result);
                });
                chats.forEach(chat => {
                    addMessage(chat.message, chat.isUser, !chat.isUser);
                });
            } catch (error) {
                console.error('Load chats error:', error);
            }
        }

        function addMessage(message, isUser = false, speakable = true) {
            try {
                const div = document.createElement('div');
                div.className = `chat-bubble ${isUser ? 'user-bubble' : 'bot-bubble'}`;
                div.innerHTML = message;
                if (!isUser && speakable) {
                    const readBtn = document.createElement('span');
                    readBtn.className = 'read-btn';
                    readBtn.innerHTML = 'üì¢';
                    readBtn.onclick = () => speak(message.replace(/<[^>]+>/g, ''));
                    div.appendChild(readBtn);
                }
                chatOutput.appendChild(div);
                chatOutput.scrollTop = chatOutput.scrollHeight;
                if (!isUser) {
                    cartoonIcon.classList.add('speaking');
                    setTimeout(() => cartoonIcon.classList.remove('speaking'), 2000);
                }
                const tx = db.transaction('chats', 'readwrite');
                const store = tx.objectStore('chats');
                store.add({ message, isUser });
            } catch (error) {
                console.error('Add message error:', error);
            }
        }

        async function loadTrainingData() {
            try {
                const tbody = document.getElementById('data-table-body');
                tbody.innerHTML = '';
                const tx = db.transaction('trainingData', 'readonly');
                const store = tx.objectStore('trainingData');
                const trainingData = await new Promise(resolve => {
                    store.getAll().onsuccess = e => resolve(e.target.result);
                });
                trainingData.forEach(data => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${data.question}</td>
                        <td>${data.answer}</td>
                        <td>${data.image ? `<img src="${sanitizeUrl(data.image)}" alt="Image" class="w-16 rounded" onerror="handleImageError(this)">` : 'N/A'}</td>
                        <td>${data.link ? `<a href="${sanitizeUrl(data.link)}" target="_blank" class="text-blue-500 hover:underline">Link</a>` : 'N/A'}</td>
                        <td>${data.file ? (data.file.type.startsWith('image/') ? `<img src="${sanitizeUrl(data.file.content)}" alt="File" class="w-16 rounded" onerror="handleImageError(this)">` : `<a href="${sanitizeUrl(data.file.content)}" download>File</a>`) : 'N/A'}</td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Load training data error:', error);
            }
        }

        function correctInput(input) {
            try {
                const corrections = {
                    'tel': 'tell', 'abot': 'about', 'javascritp': 'javascript', 'youtub': 'youtube',
                    'primeminister': 'prime minister', 'calulate': 'calculate', 'wether': 'weather',
                    'translat': 'translate', 'pythn': 'python', 'htmls': 'html', 'javas': 'javascript',
                    'logn': 'login', 'cod': 'code', 'wikipdia': 'wikipedia', 'cretae': 'create',
                    'adavnced': 'advanced', 'lgin': 'login', 'pge': 'page'
                };
                let corrected = input.toLowerCase();
                for (const [wrong, right] of Object.entries(corrections)) {
                    corrected = corrected.replace(new RegExp(wrong, 'gi'), right);
                }
                if (corrected.includes('prime') && corrected.includes('india')) corrected = 'prime minister of india';
                if (corrected.includes('java') && !corrected.includes('javascript')) corrected = 'about javascript';
                if (corrected.includes('code') && corrected.includes('log')) corrected = 'create a login page';
                if (corrected.includes('create') && corrected.includes('login')) corrected = 'create a login page';
                if (corrected.includes('advanced') && corrected.includes('login')) corrected = 'create a login page';
                return corrected;
            } catch (error) {
                console.error('Correct input error:', error);
                return input;
            }
        }

        async function processInput(voiceOnly = false) {
            try {
                let input = chatInput.value.trim();
                if (!input) return;
                input = correctInput(input);
                if (!voiceOnly) addMessage(input, true);
                chatInput.value = '';

                let response = '';
                const tx = db.transaction('trainingData', 'readonly');
                const store = tx.objectStore('trainingData');
                const trainingData = await new Promise(resolve => {
                    store.getAll().onsuccess = e => resolve(e.target.result);
                });
                const matchedData = trainingData.find(data => data.question.toLowerCase() === input) ||
                                   trainingData.find(data => input.includes(data.question.toLowerCase()));

                if (matchedData) {
                    response = matchedData.answer;
                    if (matchedData.image) response += `<br><img src="${sanitizeUrl(matchedData.image)}" alt="Image" class="w-32 rounded" onerror="handleImageError(this)">`;
                    if (matchedData.link) response += `<br><a href="${sanitizeUrl(matchedData.link)}" target="_blank" class="text-blue-500 hover:underline">Learn More</a>`;
                    if (matchedData.file) response += `<br>File: ${matchedData.file.type.startsWith('image/') ? `<img src="${sanitizeUrl(matchedData.file.content)}" alt="File" class="w-32 rounded" onerror="handleImageError(this)">` : `<a href="${sanitizeUrl(matchedData.file.content)}" download>File</a>`}`;
                } else if (input.includes('how are you')) {
                    response = "I'm doing fantastic, thanks for asking! What's on your mind? üòÑ";
                } else if (input.includes('prime minister of india')) {
                    response = await fetchWikipedia('Narendra Modi', true) || `The Prime Minister of India is Narendra Modi. <br><img src="https://via.placeholder.com/150?text=PM" alt="PM Image" class="w-32 rounded" onerror="handleImageError(this)">`;
                } else if (input.includes('about javascript')) {
                    response = 'JavaScript is a powerful programming language used for web development, enabling dynamic content and interactivity. <br><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript" target="_blank" class="text-blue-500 hover:underline">Learn More</a>';
                } else if (input.includes('create a login page')) {
                    response = `
                        <h3>Advanced React Login Page</h3>
                        <pre>
import React, { useState } from 'react';
import './Login.css';
function Login() {
  const [username, setUsername] = useState('');
  const [password, setPassword] = useState('');
  const handleSubmit = (e) => {
    e.preventDefault();
    console.log('Login:', { username, password });
  };
  return (
    <div className="login-container">
      <div className="login-card">
        <h2 className="text-2xl font-bold mb-4">Login</h2>
        <form onSubmit={handleSubmit}>
          <input
            type="text"
            placeholder="Username"
            value={username}
            onChange={(e) => setUsername(e.target.value)}
            className="border p-2 mb-3 w-full rounded"
          />
          <input
            type="password"
            placeholder="Password"
            value={password}
            onChange={(e) => setPassword(e.target.value)}
            class="border p-2 mb-3 w-full rounded"
          />
          <button type="submit" className="bg-blue-500 text-white p-2 rounded w-full">
            Login
          </button>
        </form>
      </div>
    </div>
  );
}
export default Login;
                        </pre>
                        <pre>
// Login.css
.login-container {
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
  background: linear-gradient(135deg, #1e3a8a, #3b82f6);
}
.login-card {
  background: rgba(255, 255, 255, 0.9);
  padding: 20px;
  border-radius: 10px;
  box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
}
                        </pre>`;
                } else if (input.includes('python code') || input.includes('create a flask api')) {
                    response = `
                        <h3>Flask REST API</h3>
                        <pre>
from flask import Flask, request, jsonify
from flask_cors import CORS
app = Flask(__name__)
CORS(app)
todos = []
@app.route('/todos', methods=['GET', 'POST'])
def manage_todos():
    if request.method == 'POST':
        todo = request.json
        todos.append(todo)
        return jsonify({'message': 'Todo added', 'todo': todo}), 201
    return jsonify(todos)
@app.route('/todos/<int:id>', methods=['PUT', 'DELETE'])
def update_delete_todo(id):
    if id >= len(todos):
        return jsonify({'error': 'Todo not found'}), 404
    if request.method == 'PUT':
        todos[id] = request.json
        return jsonify({'message': 'Todo updated', 'todo': todos[id]})
    todos.pop(id)
    return jsonify({'message': 'Todo deleted'})
if __name__ == '__main__':
    app.run(debug=True)
                        </pre>`;
                } else if (input.includes('javascript code')) {
                    response = `
                        <h3>Modern JavaScript Todo App</h3>
                        <pre>
class TodoApp {
  constructor() {
    this.todos = [];
    this.init();
  }
  init() {
    document.getElementById('add-btn').addEventListener('click', () => this.addTodo());
  }
  addTodo() {
    const input = document.getElementById('todo-input');
    const task = input.value.trim();
    if (task) {
      this.todos.push({ id: Date.now(), task, completed: false });
      this.render();
      input.value = '';
    }
  }
  render() {
    const list = document.getElementById('todo-list');
    list.innerHTML = this.todos.map(todo => \`
      <li>
        <input type="checkbox" \${todo.completed ? 'checked' : ''} onchange="todoApp.toggleTodo(\${todo.id})">
        <span class="\${todo.completed ? 'line-through' : ''}">\${todo.task}</span>
        <button onclick="todoApp.deleteTodo(\${todo.id})">Delete</button>
      </li>
    \`).join('');
  }
  toggleTodo(id) {
    const todo = this.todos.find(t => t.id === id);
    if (todo) {
      todo.completed = !todo.completed;
      this.render();
    }
  }
  deleteTodo(id) {
    this.todos = this.todos.filter(t => t.id !== id);
    this.render();
  }
}
const todoApp = new TodoApp();
                        </pre>
                        <pre>
<!-- index.html -->
<input id="todo-input" type="text" placeholder="Add todo">
<button id="add-btn">Add</button>
<ul id="todo-list"></ul>
<style>
  li { display: flex; gap: 10px; align-items: center; margin: 10px 0; }
  .line-through { text-decoration: line-through; }
</style>
                        </pre>`;
                } else if (input.includes('open youtube') || input.includes('open yt')) {
                    window.open('https://www.youtube.com', '_blank');
                    response = "Opening YouTube for you! Enjoy! üòÑ";
                } else if (input.includes('translate')) {
                    response = await translateText(input);
                } else if (input.includes('weather')) {
                    response = await fetchWeather(input);
                } else {
                    try {
                        const result = math.evaluate(input);
                        response = `Result: ${result}`;
                    } catch {
                        response = await fetchWikipedia(input, true) || await fetchGeneralKnowledge(input) || "Here's what I know: Try asking in a different way or check out my training page to teach me more! üòä";
                    }
                }

                if (voiceOnly) {
                    speak(response.replace(/<[^>]+>/g, ''));
                } else {
                    addMessage(response);
                }
                await syncData('push');
            } catch (error) {
                console.error('Process input error:', error);
                alert('Error processing input');
            }
        }

        async function voiceOnlyResponse() {
            try {
                if (!chatInput.value.trim()) {
                    speak("Please say or type something for me to respond to!");
                    return;
                }
                await processInput(true);
            } catch (error) {
                console.error('Voice only response error:', error);
            }
        }

        // Wikipedia API with Person Image
        async function fetchWikipedia(query, isPerson = false) {
            try {
                const response = await fetch(`https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(query)}`);
                const data = await response.json();
                if (data.extract) {
                    let result = data.extract;
                    if (isPerson && data.thumbnail) {
                        result += `<br><img src="${sanitizeUrl(data.thumbnail.source)}" alt="${query}" class="w-32 rounded" onerror="handleImageError(this)">`;
                    } else if (!isPerson && data.thumbnail) {
                        result += `<br><img src="${sanitizeUrl(data.thumbnail.source)}" alt="${query}" class="w-32 rounded" onerror="handleImageError(this)">`;
                    } else if (isPerson) {
                        result += `<br><img src="https://via.placeholder.com/150?text=${encodeURIComponent(query)}" alt="${query}" class="w-32 rounded" onerror="handleImageError(this)">`;
                    }
                    return result;
                }
                return null;
            } catch {
                return null;
            }
        }

        // General Knowledge Fallback (DuckDuckGo API)
        async function fetchGeneralKnowledge(query) {
            try {
                const response = await fetch(`https://api.duckduckgo.com/?q=${encodeURIComponent(query)}&format=json`);
                const data = await response.json();
                if (data.Abstract) {
                    return `${data.Abstract} <br><a href="${sanitizeUrl(data.AbstractURL)}" target="_blank" class="text-blue-500 hover:underline">Read More</a>`;
                }
                return null;
            } catch {
                return null;
            }
        }

        // Translation API
        async function translateText(input) {
            try {
                const match = input.match(/translate (.+) to (.+)/i);
                if (!match) return "Please specify text and target language (e.g., 'translate hello to Spanish').";
                const text = match[1];
                const targetLang = match[2].toLowerCase();
                const langMap = { spanish: 'es', hindi: 'hi', french: 'fr', urdu: 'ur' };
                const langCode = langMap[targetLang] || 'en';
                const response = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=en|${langCode}`);
                const data = await response.json();
                return data.responseData.translatedText;
            } catch {
                return "Translation failed. Try again later.";
            }
        }

        // Weather API
        async function fetchWeather(input) {
            try {
                const match = input.match(/weather in (.+)/i);
                if (!match) return "Please specify a location (e.g., 'weather in Delhi').";
                const location = match[1];
                const response = await fetch(`https://wttr.in/${encodeURIComponent(location)}?format=%C+%t`);
                const data = await response.text();
                return `Weather in ${location}: ${data}`;
            } catch {
                return "Weather data unavailable. Try again later.";
            }
        }

        // Voice Input
        if ('webkitSpeechRecognition' in window) {
            recognition = new webkitSpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US';

            recognition.onresult = event => {
                try {
                    let interimTranscript = '';
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            chatInput.value = transcript;
                            processInput();
                        } else {
                            interimTranscript += transcript;
                        }
                    }
                    chatInput.value = interimTranscript;
                } catch (error) {
                    console.error('Speech recognition error:', error);
                }
            };

            recognition.onend = () => {
                if (isListening) recognition.start();
            };
        }

        function toggleMic() {
            try {
                if (!recognition) {
                    alert('Speech recognition not supported in this browser.');
                    return;
                }
                if (isListening) {
                    recognition.stop();
                    document.querySelector('button[onclick="toggleMic()"]').textContent = 'üé§ Mic';
                    isListening = false;
                } else {
                    recognition.start();
                    document.querySelector('button[onclick="toggleMic()"]').textContent = 'üé§ Stop';
                    isListening = true;
                }
            } catch (error) {
                console.error('Toggle mic error:', error);
            }
        }

        // Voice Training
        let trainingField = null;
        function startVoiceTraining(field) {
            try {
                if (!recognition) {
                    alert('Speech recognition not supported in this browser.');
                    return;
                }
                trainingField = field;
                recognition.onresult = event => {
                    const transcript = event.results[event.results.length - 1][0].transcript;
                    if (event.results[event.results.length - 1].isFinal) {
                        document.getElementById(`train-${trainingField}`).value = transcript;
                        recognition.stop();
                        trainingField = null;
                        recognition.onresult = event => {
                            let interimTranscript = '';
                            for (let i = event.resultIndex; i < event.results.length; i++) {
                                const transcript = event.results[i][0].transcript;
                                if (event.results[i].isFinal) {
                                    chatInput.value = transcript;
                                    processInput();
                                } else {
                                    interimTranscript += transcript;
                                }
                            }
                            chatInput.value = interimTranscript;
                        };
                    }
                };
                recognition.start();
            } catch (error) {
                console.error('Voice training error:', error);
            }
        }

        // Voice Output
        function speak(text) {
            try {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = document.getElementById('language-select').value;
                utterance.rate = 1;
                utterance.pitch = 1;
                utterance.onstart = () => cartoonIcon.classList.add('speaking');
                utterance.onend = () => cartoonIcon.classList.remove('speaking');
                speechSynthesis.speak(utterance);
            } catch (error) {
                console.error('Speak error:', error);
            }
        }

        // Training System with File Upload
        async function trainBot() {
            try {
                const question = document.getElementById('train-question').value;
                const answer = document.getElementById('train-answer').value;
                const image = document.getElementById('train-image').value;
                const link = document.getElementById('train-link').value;
                const fileInput = document.getElementById('train-file');
                let fileData = null;

                if (!question || !answer) {
                    alert('Please provide both question and answer');
                    return;
                }

                if (fileInput.files.length > 0) {
                    const file = fileInput.files[0];
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        fileData = await new Promise(resolve => {
                            reader.onload = () => resolve({ type: file.type, content: reader.result });
                            reader.readAsDataURL(file);
                        });
                    } else if (file.type === 'text/plain') {
                        const reader = new FileReader();
                        fileData = await new Promise(resolve => {
                            reader.onload = () => resolve({ type: file.type, content: reader.result });
                            reader.readAsText(file);
                        });
                    } else {
                        alert('Unsupported file type. Use text or image files.');
                        return;
                    }
                }

                const tx = db.transaction('trainingData', 'readwrite');
                const store = tx.objectStore('trainingData');
                await store.add({ question, answer, image, link, file: fileData });
                alert('Training data added!');
                document.getElementById('train-question').value = '';
                document.getElementById('train-answer').value = '';
                document.getElementById('train-image').value = '';
                document.getElementById('train-link').value = '';
                document.getElementById('train-file').value = '';
                await syncData('push');
            } catch (error) {
                console.error('Train bot error:', error);
                alert('Error adding training data');
            }
        }

        // Handle text input
        chatInput.addEventListener('keypress', e => {
            if (e.key === 'Enter') processInput();
        });

        // Multi-language support
        function setLanguage(lang) {
            try {
                if (recognition) recognition.lang = lang;
            } catch (error) {
                console.error('Set language error:', error);
            }
        }

        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js', { scope: '/' })
                .then(reg => {
                    console.log('Service Worker registered successfully', reg);
                })
                .catch(err => {
                    console.error('Service Worker registration failed:', err);
                    console.error('Error details:', err.message, err.stack);
                });
        } else {
            console.warn('Service Worker not supported in this browser');
        }
    </script>
</body>
</html>
